<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>柳比歇夫时间统计报告</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f7fa;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1, h2 {
            color: #2c3e50;
            text-align: center;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        .card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
            margin-bottom: 20px;
        }
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .summary-item {
            background-color: #f8f9fa;
            border-left: 5px solid; /* Will be set dynamically */
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .summary-item h3 {
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 1.2em;
            color: #2c3e50;
            cursor: pointer; /* Add cursor pointer for collapsibles */
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .summary-item .total-time {
            font-size: 2em;
            font-weight: bold;
            color: #34495e;
            margin-bottom: 15px;
        }
        .summary-item .subcategory {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            color: #555;
            line-height: 1.5;
        }
        .tab-container {
            margin-bottom: 20px;
        }
        .tab-buttons {
            display: flex;
            border-bottom: 2px solid #ddd;
            flex-wrap: wrap;
        }
        .tab-button {
            padding: 10px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            color: #666;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
        }
        .tab-button.active {
            color: #3498db;
            border-bottom-color: #3498db;
        }
        .tab-content {
            display: none;
            padding: 20px 0;
        }
        .tab-content.active {
            display: block;
        }
        .chart-container {
            height: 500px;
            width: 100%;
        }
        .chart-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
        }
        .chart-wrapper {
            width: 100%;
        }
        .footer {
            margin-top: 30px;
            text-align: center;
            font-size: 0.9em;
            color: #888;
        }

        /* Styles for new details section */
        .details-container {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }
        .category-details h3 {
            margin: 0 0 15px 0;
            padding-left: 15px;
            border-left: 4px solid; /* color set dynamically */
            display: flex;
            align-items: center;
            font-size: 1.5em;
        }
        .category-color-indicator {
            display: inline-block;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            margin-right: 10px;
            position: relative;
            left: -27px;
        }
        .category-total-time {
            margin-left: auto;
            font-size: 0.8em;
            font-weight: normal;
            background-color: #e9ecef;
            padding: 3px 8px;
            border-radius: 12px;
            color: #555;
        }
        .item-details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
            padding-left: 20px;
        }
        .item-card {
            background-color: #fdfdfd;
            border: 1px solid #eef;
            border-radius: 6px;
            padding: 15px;
        }
        .item-card h4 {
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 1.1em;
            color: #333;
            display: flex;
            justify-content: space-between;
        }
        .item-total-time {
            font-weight: normal;
            color: #777;
        }
        .item-card ul {
            list-style-type: none;
            padding: 0;
            margin: 0;
        }
        .item-card li {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        .item-card li:last-child {
            border-bottom: none;
        }
        .task-name {
            color: #555;
        }
        .task-time {
            font-weight: bold;
            color: #333;
        }
        .task-list {
            margin-top: 10px;
            padding-left: 10px;
            border-left: 2px solid #e0e0e0;
        }
        .task-list-item {
            display: flex;
            justify-content: space-between;
            font-size: 0.9em;
            color: #666;
            margin-bottom: 5px;
        }
        .dark-mode .task-list {
            border-left-color: #555;
        }
        .dark-mode .task-list-item {
            color: #ccc;
        }

        /* Dark Mode Styles */
        body.dark-mode {
            background-color: #1a1a1a;
            color: #e0e0e0;
        }
        .dark-mode .card {
            background-color: #2c2c2c;
            box-shadow: 0 2px 10px rgba(0,0,0,0.4);
            border-top: 1px solid #444;
        }
        .dark-mode h1, .dark-mode h2 {
            color: #ffffff;
            border-bottom-color: #444;
        }
        .dark-mode .summary-item {
            background-color: #333;
            color: #f1f1f1;
        }
        .dark-mode .summary-item h3, .dark-mode .summary-item .total-time {
            color: #ffffff;
        }
        .dark-mode .summary-item .subcategory {
            color: #ccc;
        }
        .dark-mode .category-details h3 {
            border-left-color: #fff !important; /* Override inline style for visibility */
        }
        .dark-mode .item-card {
            background-color: #333;
            border-color: #444;
        }
        .dark-mode .item-card h4, .dark-mode .task-name, .dark-mode .task-time, .dark-mode .item-total-time {
            color: #f1f1f1;
        }
        .dark-mode .item-card li {
            border-bottom-color: #444;
        }
        .dark-mode .footer {
            color: #aaa;
        }
        .dark-mode .tab-buttons {
            border-bottom-color: #444;
        }
        .dark-mode .tab-button {
            color: #bbb;
        }
        .dark-mode .tab-button.active {
            color: #4a90e2;
            border-bottom-color: #4a90e2;
        }

        /* Dark Mode Styles for Charts */
        .dark-mode .echarts-label {
            color: #ccc !important;
        }
        .dark-mode .pie-label-rich-name, .dark-mode .pie-label-rich-time, .dark-mode .pie-label-rich-percent {
            color: #ddd !important;
        }

        /* Theme Toggle Switch */
        .theme-switch-wrapper {
            display: flex;
            align-items: center;
            position: absolute;
            top: 20px;
            right: 20px;
        }
        .theme-switch {
            display: inline-block;
            height: 34px;
            position: relative;
            width: 60px;
        }
        .theme-switch input {
            display:none;
        }
        .slider {
            background-color: #ccc;
            bottom: 0;
            cursor: pointer;
            left: 0;
            position: absolute;
            right: 0;
            top: 0;
            transition: .4s;
            border-radius: 34px;
        }
        .slider:before {
            background-color: #fff;
            bottom: 4px;
            content: "";
            height: 26px;
            left: 4px;
            position: absolute;
            transition: .4s;
            width: 26px;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: #2196F3;
        }
        input:checked + .slider:before {
            transform: translateX(26px);
        }

        .collapsible-content {
            display: none; /* Hidden by default */
            padding-top: 10px;
            border-top: 1px solid #e9ecef;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="theme-switch-wrapper">
        <label class="theme-switch" for="checkbox">
            <input type="checkbox" id="checkbox" />
            <div class="slider"></div>
        </label>
    </div>

    <div class="container">
        <h1>
            柳比歇夫时间统计报告 
            
            <span style="font-size: 0.7em; color: #555; vertical-align: middle;">- 2025-06-18</span>
            
        </h1>

        <!-- Card 1: Overview -->
        <div class="card">
            <h2>总览</h2>
            <div class="summary-grid">
                <!-- Jinja2 loop for summary cards -->
                
                <div class="summary-item" style="border-left-color: #2ecc71;">
                    <h3 onclick="toggleSummary('content-1')">
                        <span>第二类</span>
                        <span class="total-time">7h 35m</span>
                    </h3>
                    <div class="collapsible-content" id="content-1">
                        
                        <div class="subcategory">
                            <span>折腾</span>
                            <strong>6h 1m</strong>
                        </div>
                        <div class="task-list">
                            
                            <div class="task-list-item">
                                <span>柳比歇夫日结可视化</span>
                                <strong>6h 1m</strong>
                            </div>
                            
                        </div>
                        
                        <div class="subcategory">
                            <span>锻炼</span>
                            <strong>59m</strong>
                        </div>
                        <div class="task-list">
                            
                            <div class="task-list-item">
                                <span>节奏光剑</span>
                                <strong>59m</strong>
                            </div>
                            
                        </div>
                        
                        <div class="subcategory">
                            <span>冲浪</span>
                            <strong>13m</strong>
                        </div>
                        <div class="task-list">
                            
                            <div class="task-list-item">
                                <span>小黑盒</span>
                                <strong>13m</strong>
                            </div>
                            
                        </div>
                        
                        <div class="subcategory">
                            <span>博物</span>
                            <strong>22m</strong>
                        </div>
                        <div class="task-list">
                            
                            <div class="task-list-item">
                                <span>丝之歌为何不发售</span>
                                <strong>22m</strong>
                            </div>
                            
                        </div>
                        
                    </div>
                </div>
                
                <div class="summary-item" style="border-left-color: #9b59b6;">
                    <h3 onclick="toggleSummary('content-2')">
                        <span>根源</span>
                        <span class="total-time">47m</span>
                    </h3>
                    <div class="collapsible-content" id="content-2">
                        
                        <div class="subcategory">
                            <span>游戏</span>
                            <strong>47m</strong>
                        </div>
                        <div class="task-list">
                            
                            <div class="task-list-item">
                                <span>潜渊症</span>
                                <strong>47m</strong>
                            </div>
                            
                        </div>
                        
                    </div>
                </div>
                
                <div class="summary-item" style="border-left-color: #f1c40f;">
                    <h3 onclick="toggleSummary('content-3')">
                        <span>娱乐</span>
                        <span class="total-time">3h 21m</span>
                    </h3>
                    <div class="collapsible-content" id="content-3">
                        
                        <div class="subcategory">
                            <span>小说</span>
                            <strong>4m</strong>
                        </div>
                        <div class="task-list">
                            
                            <div class="task-list-item">
                                <span>惊涛落日</span>
                                <strong>4m</strong>
                            </div>
                            
                        </div>
                        
                        <div class="subcategory">
                            <span>游戏</span>
                            <strong>3h 17m</strong>
                        </div>
                        <div class="task-list">
                            
                            <div class="task-list-item">
                                <span>er</span>
                                <strong>2h 40m</strong>
                            </div>
                            
                            <div class="task-list-item">
                                <span>卢岛食堂</span>
                                <strong>37m</strong>
                            </div>
                            
                        </div>
                        
                    </div>
                </div>
                
                <div class="summary-item" style="border-left-color: #e74c3c;">
                    <h3 onclick="toggleSummary('content-4')">
                        <span>杂项</span>
                        <span class="total-time">2h 39m</span>
                    </h3>
                    <div class="collapsible-content" id="content-4">
                        
                        <div class="subcategory">
                            <span>日常</span>
                            <strong>1h 27m</strong>
                        </div>
                        <div class="task-list">
                            
                            <div class="task-list-item">
                                <span>琐事</span>
                                <strong>40m</strong>
                            </div>
                            
                            <div class="task-list-item">
                                <span>睡觉</span>
                                <strong>47m</strong>
                            </div>
                            
                        </div>
                        
                        <div class="subcategory">
                            <span>工程</span>
                            <strong>1h 12m</strong>
                        </div>
                        <div class="task-list">
                            
                            <div class="task-list-item">
                                <span>琐事</span>
                                <strong>2m</strong>
                            </div>
                            
                            <div class="task-list-item">
                                <span>作业</span>
                                <strong>1h 10m</strong>
                            </div>
                            
                        </div>
                        
                    </div>
                </div>
                

                <!-- Grand Total Card -->
                <div class="summary-item" style="border-left-color: #7f8c8d;">
                    <h3>总计</h3>
                    <div class="total-time">14h 22m</div>
                </div>
            </div>
        </div>
        
        <!-- Card 2: Daily Chart Analysis -->
        <div class="card">
            <h2>当日图表分析</h2>
            <div class="chart-grid">
                <div class="chart-wrapper">
                    <h3>时间分配比例 (主类)</h3>
                    <div class="chart-container" id="pieChartContainer"></div>
                </div>
                <div class="chart-wrapper">
                    <h3>各类别子项时间分配</h3>
                    <div class="chart-container" id="stackedBarContainer" style="height: 600px;"></div>
                </div>
                <div class="chart-wrapper">
                    <h3>时间分配层次结构</h3>
                    <div class="chart-container" id="sunburstChartContainer"></div>
                </div>
            </div>
        </div>

        <!-- Card 3: Historical Analysis -->
        

        <div class="footer">
            <p>报告生成于 2025-06-26 17:48:13</p>
        </div>
    </div>

    <div class="chart-container" id="historical-chart-container"></div>

    <!-- Chart Library Section -->
    <div class="section-container">
        <h2 class="section-title">Chart Library</h2>
        <div class="chart-grid">
            <div class="chart-container" id="treemap-chart-container"></div>
            <div class="chart-container" id="streamgraph-chart-container"></div>
        </div>
        <div id="small-multiples-container">
            <!-- Small Multiples will be dynamically generated here -->
        </div>
    </div>

    <script>
        // --- Utility Functions (from example) ---
        function minutesToTime(minutes) {
            if (minutes === null || minutes === undefined || minutes < 0) return '0m';
            if (minutes === 0) return '0m';
            const hours = Math.floor(minutes / 60);
            const mins = minutes % 60;
            let result = '';
            if (hours > 0) result += `${hours}h`;
            if (mins > 0) result += (hours > 0 ? ' ' : '') + `${mins}m`;
            return result;
        }
        
        function toggleSummary(elementId) {
            const content = document.getElementById(elementId);
            if (content.style.display === 'block') {
                content.style.display = 'none';
            } else {
                content.style.display = 'block';
            }
        }
        
        // --- Data from Python (Now always the same variables) ---
        const chartData = [{"children": [{"children": [{"name": "\u67f3\u6bd4\u6b47\u592b\u65e5\u7ed3\u53ef\u89c6\u5316", "time_str": "6h 1m", "value": 361}], "name": "\u6298\u817e", "value": 361, "value_str": "6h 1m"}, {"children": [{"name": "\u8282\u594f\u5149\u5251", "time_str": "59m", "value": 59}], "name": "\u953b\u70bc", "value": 59, "value_str": "59m"}, {"children": [{"name": "\u5c0f\u9ed1\u76d2", "time_str": "13m", "value": 13}], "name": "\u51b2\u6d6a", "value": 13, "value_str": "13m"}, {"children": [{"name": "\u4e1d\u4e4b\u6b4c\u4e3a\u4f55\u4e0d\u53d1\u552e", "time_str": "22m", "value": 22}], "name": "\u535a\u7269", "value": 22, "value_str": "22m"}], "itemStyle": {"color": "#2ecc71"}, "name": "\u7b2c\u4e8c\u7c7b", "value": 455, "value_str": "7h 35m"}, {"children": [{"children": [{"name": "\u6f5c\u6e0a\u75c7", "time_str": "47m", "value": 47}], "name": "\u6e38\u620f", "value": 47, "value_str": "47m"}], "itemStyle": {"color": "#9b59b6"}, "name": "\u6839\u6e90", "value": 47, "value_str": "47m"}, {"children": [{"children": [{"name": "\u60ca\u6d9b\u843d\u65e5", "time_str": "4m", "value": 4}], "name": "\u5c0f\u8bf4", "value": 4, "value_str": "4m"}, {"children": [{"name": "er", "time_str": "2h 40m", "value": 160}, {"name": "\u5362\u5c9b\u98df\u5802", "time_str": "37m", "value": 37}], "name": "\u6e38\u620f", "value": 197, "value_str": "3h 17m"}], "itemStyle": {"color": "#f1c40f"}, "name": "\u5a31\u4e50", "value": 201, "value_str": "3h 21m"}, {"children": [{"children": [{"name": "\u7410\u4e8b", "time_str": "40m", "value": 40}, {"name": "\u7761\u89c9", "time_str": "47m", "value": 47}], "name": "\u65e5\u5e38", "value": 87, "value_str": "1h 27m"}, {"children": [{"name": "\u7410\u4e8b", "time_str": "2m", "value": 2}, {"name": "\u4f5c\u4e1a", "time_str": "1h 10m", "value": 70}], "name": "\u5de5\u7a0b", "value": 72, "value_str": "1h 12m"}], "itemStyle": {"color": "#e74c3c"}, "name": "\u6742\u9879", "value": 159, "value_str": "2h 39m"}];
        const pieData = [{"itemStyle": {"color": "#2ecc71"}, "name": "\u7b2c\u4e8c\u7c7b", "value": 455}, {"itemStyle": {"color": "#9b59b6"}, "name": "\u6839\u6e90", "value": 47}, {"itemStyle": {"color": "#f1c40f"}, "name": "\u5a31\u4e50", "value": 201}, {"itemStyle": {"color": "#e74c3c"}, "name": "\u6742\u9879", "value": 159}];
        const stackedBarData = {"legend": ["\u51b2\u6d6a", "\u535a\u7269", "\u5c0f\u8bf4", "\u5de5\u7a0b", "\u6298\u817e", "\u65e5\u5e38", "\u6e38\u620f", "\u953b\u70bc"], "series": [{"data": [13, 0, 0, 0], "emphasis": {"focus": "series"}, "name": "\u51b2\u6d6a", "stack": "total", "type": "bar"}, {"data": [22, 0, 0, 0], "emphasis": {"focus": "series"}, "name": "\u535a\u7269", "stack": "total", "type": "bar"}, {"data": [0, 0, 4, 0], "emphasis": {"focus": "series"}, "name": "\u5c0f\u8bf4", "stack": "total", "type": "bar"}, {"data": [0, 0, 0, 72], "emphasis": {"focus": "series"}, "name": "\u5de5\u7a0b", "stack": "total", "type": "bar"}, {"data": [361, 0, 0, 0], "emphasis": {"focus": "series"}, "name": "\u6298\u817e", "stack": "total", "type": "bar"}, {"data": [0, 0, 0, 87], "emphasis": {"focus": "series"}, "name": "\u65e5\u5e38", "stack": "total", "type": "bar"}, {"data": [0, 47, 197, 0], "emphasis": {"focus": "series"}, "name": "\u6e38\u620f", "stack": "total", "type": "bar"}, {"data": [59, 0, 0, 0], "emphasis": {"focus": "series"}, "name": "\u953b\u70bc", "stack": "total", "type": "bar"}], "yAxis": ["\u7b2c\u4e8c\u7c7b", "\u6839\u6e90", "\u5a31\u4e50", "\u6742\u9879"]};
        const historicalData = {"categories": ["\u5a31\u4e50", "\u6742\u9879", "\u6839\u6e90", "\u7b2c\u4e00\u7c7b", "\u7b2c\u4e8c\u7c7b"], "dates": ["2025-06-11", "2025-06-12", "2025-06-13", "2025-06-14", "2025-06-15", "2025-06-16", "2025-06-17", "2025-06-18", "2025-06-19", "2025-06-20", "2025-06-21", "2025-06-22", "2025-06-23", "2025-06-24", "2025-06-25"], "series": [{"data": [272.0, 382.0, 408.0, 287.0, 737.0, 546.0, 605.0, 201.0, 284.0, 416.0, 212.0, 233.0, 270.0, 168.0, 253.0], "name": "\u5a31\u4e50", "type": "line"}, {"data": [276.0, 199.0, 87.0, 72.0, 41.0, 92.0, 193.0, 159.0, 36.0, 193.0, 202.0, 421.0, 377.0, 213.0, 230.0], "name": "\u6742\u9879", "type": "line"}, {"data": [20.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 47.0, 407.0, 163.0, 210.0, 0.0, 83.0, 0.0, 0.0], "name": "\u6839\u6e90", "type": "line"}, {"data": [0.0, 0.0, 0.0, 162.0, 0.0, 107.0, 0.0, 0.0, 0.0, 0.0, 43.0, 80.0, 0.0, 28.0, 0.0], "name": "\u7b2c\u4e00\u7c7b", "type": "line"}, {"data": [267.0, 306.0, 390.0, 256.0, 58.0, 142.0, 69.0, 455.0, 159.0, 119.0, 178.0, 129.0, 80.0, 523.0, 454.0], "name": "\u7b2c\u4e8c\u7c7b", "type": "line"}]};

        // --- Chart Initialization ---
        function initCharts(theme = 'light') {
            const isDarkMode = theme === 'dark';

            // --- Dispose All Charts before re-init ---
            disposeChart('sunburstChartContainer');
            disposeChart('pieChartContainer');
            disposeChart('stackedBarContainer');
            disposeChart('stackedAreaContainer');

            // --- Initialize Charts ---
            initSunburstChart(theme);
            initPieChart(theme, isDarkMode);
            initStackedBarChart(theme);
            
            initStackedAreaChart(theme);
        }

        function disposeChart(containerId) {
            const container = document.getElementById(containerId);
            if (container) {
                const instance = echarts.getInstanceByDom(container);
                if (instance) {
                    instance.dispose();
                }
            }
        }

        // --- Sunburst Chart ---
        function initSunburstChart(theme) {
            const container = document.getElementById('sunburstChartContainer');
            if (!container) return;
            const sunburstChart = echarts.init(container, theme);
            sunburstChart.setOption({
                title: { text: '', left: 'center' },
                tooltip: {
                    trigger: 'item',
                    formatter: function(params) {
                        return `${params.name}: ${minutesToTime(params.value)}`;
                    }
                },
                legend: {
                    orient: 'vertical',
                    left: 'right',
                    top: 'center'
                },
                series: {
                    type: 'sunburst',
                    data: chartData,
                    radius: [0, '90%'],
                    label: {
                        rotate: 'radial',
                        formatter: function(params) {
                            if (params.data.value / params.treePathInfo[0].value < 0.01 && params.treePathInfo.length > 2) {
                                return '';
                            }
                            // Always show name and time
                            return `${params.name} ${minutesToTime(params.value)}`;
                        }
                    },
                    levels: [
                        {}, // Level 0 (center)
                        {}, // Level 1 (categories)
                        { // Level 2 (items)
                          label: {
                            show: false
                          }
                        },
                        { // Level 3 (tasks)
                            label: { 
                                show: true,
                                rotate: 'tangential'
                            },
                            emphasis: {
                                label: { show: true }
                            }
                        }
                    ],
                    emphasis: { focus: 'ancestor' }
                }
            });
            window.addEventListener('resize', () => sunburstChart.resize());
            window.dispatchEvent(new Event('resize'));
        }

        // --- Pie Chart ---
        function initPieChart(theme, isDarkMode) {
            const container = document.getElementById('pieChartContainer');
            if (!container) return;
            const pieChart = echarts.init(container, theme);
            pieChart.setOption({
                title: { text: '', left: 'center' },
                tooltip: {
                    trigger: 'item',
                    formatter: function(params) {
                        return `${params.seriesName}<br/>${params.name}: ${minutesToTime(params.value)} (${params.percent}%)`;
                    }
                },
                legend: { 
                    orient: 'vertical',
                    left: 'right',
                    top: 'center'
                }, 
                series: [{
                    name: '时间分配',
                    type: 'pie',
                    radius: '60%', // Adjust radius to give labels more space
                    center: ['50%', '55%'],
                    data: pieData,
                    emphasis: {
                        itemStyle: { shadowBlur: 10, shadowOffsetX: 0, shadowColor: 'rgba(0, 0, 0, 0.5)' }
                    },
                    label: {
                        show: true,
                        position: 'outer',
                        formatter: function(params) {
                            // Use different class for dark mode to apply specific styles
                            const richClass = isDarkMode ? 'pie-label-rich-dark' : 'pie-label-rich';
                            return `{name|${params.name}}\n{time|${minutesToTime(params.value)}} ({percent|${params.percent}%})`;
                        },
                        rich: {
                            name: {
                                fontSize: 14,
                                color: isDarkMode ? '#eee' : '#333'
                            },
                            time: {
                                fontSize: 12,
                                color: isDarkMode ? '#ccc' : '#666',
                                padding: [2, 0]
                            },
                            percent: {
                                fontSize: 12,
                                color: isDarkMode ? '#ccc' : '#666'
                            }
                        }
                    },
                    labelLine: {
                        show: true,
                        length: 15,
                        length2: 10
                    }
                }]
            });
            window.addEventListener('resize', () => pieChart.resize());
        }
        
        // --- Stacked Bar Chart ---
        function initStackedBarChart(theme) {
            const container = document.getElementById('stackedBarContainer');
            if (!container) return;
            const stackedBarChart = echarts.init(container, theme);
            stackedBarChart.setOption({
                title: { text: '', left: 'center' },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'shadow' },
                    formatter: function(params) {
                        let categoryName = params[0].axisValue;
                        let total = 0;
                        let result = `${categoryName}<br/>`;
                        params.forEach(param => {
                            if (param.value > 0) {
                                total += param.value;
                                result += `${param.marker} ${param.seriesName}: ${minutesToTime(param.value)}<br/>`;
                            }
                        });
                        result += `<b>总计: ${minutesToTime(total)}</b>`;
                        return result;
                    }
                },
                legend: {
                    type: 'scroll',
                    orient: 'vertical',
                    right: 10,
                    top: 40,
                    bottom: 20,
                    data: stackedBarData.legend
                },
                grid: { left: '3%', right: '15%', bottom: '3%', containLabel: true },
                xAxis: {
                    type: 'value',
                    axisLabel: { formatter: minutesToTime }
                },
                yAxis: {
                    type: 'category',
                    data: stackedBarData.yAxis
                },
                series: stackedBarData.series.map(s => ({
                    ...s,
                    label: {
                        show: true,
                        position: 'inside',
                        formatter: function(params) {
                             if (params.value <= 0) return '';
                             // Show both name and time, similar to the reference example
                             const subName = params.seriesName;
                             return `${subName}\n${minutesToTime(params.value)}`;
                        },
                        color: '#fff',
                        textShadowBlur: 1,
                        textShadowColor: 'rgba(0, 0, 0, 0.4)'
                    }
                }))
            });
            window.addEventListener('resize', () => stackedBarChart.resize());
        }

        // --- Stacked Area Chart (Upgraded from Line Chart) ---
        function initStackedAreaChart(theme) {
            const container = document.getElementById('stackedAreaContainer');
            if (!container || !historicalData || !historicalData.dates) return;
            
            const stackedAreaChart = echarts.init(container, theme);
            stackedAreaChart.setOption({
                title: { text: '', left: 'center' },
                tooltip: {
                    trigger: 'axis',
                    formatter: function (params) {
                        let res = params[0].name + '<br/>';
                        let total = 0;
                        params.forEach(function (item) {
                            total += item.value;
                            res += item.marker + ' ' + item.seriesName + ' : ' + minutesToTime(item.value) + '<br/>';
                        });
                        res += `<b>总计: ${minutesToTime(total)}</b>`;
                        return res;
                    }
                },
                legend: {
                    data: historicalData.categories,
                    top: 'bottom'
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '10%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    boundaryGap: false,
                    data: historicalData.dates
                },
                yAxis: {
                    type: 'value',
                    axisLabel: {
                        formatter: minutesToTime
                    }
                },
                series: historicalData.series.map(s => ({
                    ...s,
                    stack: 'Total', // This makes it a stacked area chart
                    areaStyle: {}   // This fills the area
                }))
            });
        }

        // --- Theme Toggling Logic ---
        const toggleSwitch = document.querySelector('.theme-switch input[type="checkbox"]');
        const currentTheme = localStorage.getItem('theme');

        function switchTheme(e) {
            if (e.target.checked) {
                document.body.classList.add('dark-mode');
                localStorage.setItem('theme', 'dark');
                initCharts('dark');
            } else {
                document.body.classList.remove('dark-mode');
                localStorage.setItem('theme', 'light');
                initCharts('light');
            }    
        }

        toggleSwitch.addEventListener('change', switchTheme, false);

        if (currentTheme) {
            document.body.classList.toggle('dark-mode', currentTheme === 'dark');
            toggleSwitch.checked = currentTheme === 'dark';
        }

        // --- Page Load ---
        window.onload = function() {
            initCharts(currentTheme || 'light');
            
            // Initial resize logic is a bit complex now. The initCharts handles it.
            // Let's just keep the theme-based initialization.
        };

        // --- 9. Historical Trend Chart (Line Chart) ---
        var historicalChartDom = document.getElementById('historical-chart-container');
        if (historicalChartDom && historicalData) {
            var historicalChart = echarts.init(historicalChartDom, 'dark');
            var historicalOption = {
                title: {
                    text: 'Historical Time Allocation Trends',
                    left: 'center',
                    textStyle: { color: '#eee' }
                },
                tooltip: {
                    trigger: 'axis',
                    formatter: function (params) {
                        let result = params[0].name + '<br/>';
                        params.forEach(param => {
                            let minutes = param.value || 0;
                            let timeStr = minutesToTime(minutes);
                            result += param.marker + ' ' + param.seriesName + ': ' + timeStr + ' (' + minutes.toFixed(2) + ' min)<br/>';
                        });
                        return result;
                    }
                },
                legend: {
                    data: historicalData.categories,
                    top: 'bottom',
                    textStyle: { color: '#ccc' }
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '10%',
                    containLabel: true
                },
                toolbox: {
                    feature: {
                        saveAsImage: {}
                    },
                    iconStyle: { borderColor: '#ccc' }
                },
                xAxis: {
                    type: 'category',
                    boundaryGap: false,
                    data: historicalData.dates,
                    axisLine: { lineStyle: { color: '#888' } },
                    axisLabel: { color: '#ccc' }
                },
                yAxis: {
                    type: 'value',
                    axisLabel: {
                        formatter: function (value) {
                            return minutesToTime(value);
                        },
                        color: '#ccc'
                    },
                    axisLine: { lineStyle: { color: '#888' } }
                },
                series: historicalData.series.map(s => Object.assign(s, { type: 'line', smooth: true }))
            };
            historicalChart.setOption(historicalOption);
        }

        // --- 10. Treemap Chart ---
        var treemapData = [{"children": [{"children": [{"name": "\u67f3\u6bd4\u6b47\u592b\u65e5\u7ed3\u53ef\u89c6\u5316", "time_str": "6h 1m", "value": 361}], "name": "\u6298\u817e", "value": 361, "value_str": "6h 1m"}, {"children": [{"name": "\u8282\u594f\u5149\u5251", "time_str": "59m", "value": 59}], "name": "\u953b\u70bc", "value": 59, "value_str": "59m"}, {"children": [{"name": "\u5c0f\u9ed1\u76d2", "time_str": "13m", "value": 13}], "name": "\u51b2\u6d6a", "value": 13, "value_str": "13m"}, {"children": [{"name": "\u4e1d\u4e4b\u6b4c\u4e3a\u4f55\u4e0d\u53d1\u552e", "time_str": "22m", "value": 22}], "name": "\u535a\u7269", "value": 22, "value_str": "22m"}], "itemStyle": {"color": "#2ecc71"}, "name": "\u7b2c\u4e8c\u7c7b", "value": 455, "value_str": "7h 35m"}, {"children": [{"children": [{"name": "\u6f5c\u6e0a\u75c7", "time_str": "47m", "value": 47}], "name": "\u6e38\u620f", "value": 47, "value_str": "47m"}], "itemStyle": {"color": "#9b59b6"}, "name": "\u6839\u6e90", "value": 47, "value_str": "47m"}, {"children": [{"children": [{"name": "\u60ca\u6d9b\u843d\u65e5", "time_str": "4m", "value": 4}], "name": "\u5c0f\u8bf4", "value": 4, "value_str": "4m"}, {"children": [{"name": "er", "time_str": "2h 40m", "value": 160}, {"name": "\u5362\u5c9b\u98df\u5802", "time_str": "37m", "value": 37}], "name": "\u6e38\u620f", "value": 197, "value_str": "3h 17m"}], "itemStyle": {"color": "#f1c40f"}, "name": "\u5a31\u4e50", "value": 201, "value_str": "3h 21m"}, {"children": [{"children": [{"name": "\u7410\u4e8b", "time_str": "40m", "value": 40}, {"name": "\u7761\u89c9", "time_str": "47m", "value": 47}], "name": "\u65e5\u5e38", "value": 87, "value_str": "1h 27m"}, {"children": [{"name": "\u7410\u4e8b", "time_str": "2m", "value": 2}, {"name": "\u4f5c\u4e1a", "time_str": "1h 10m", "value": 70}], "name": "\u5de5\u7a0b", "value": 72, "value_str": "1h 12m"}], "itemStyle": {"color": "#e74c3c"}, "name": "\u6742\u9879", "value": 159, "value_str": "2h 39m"}];
        var treemapChartDom = document.getElementById('treemap-chart-container');
        if (treemapChartDom && treemapData) {
            var treemapChart = echarts.init(treemapChartDom, 'dark');
            var treemapOption = {
                title: {
                    text: 'Treemap of Time Allocation',
                    left: 'center',
                    textStyle: { color: '#eee' }
                },
                tooltip: {
                    formatter: function (info) {
                        var value = info.value;
                        var treePathInfo = info.treePathInfo;
                        var treePath = [];
                        for (var i = 1; i < treePathInfo.length; i++) {
                            treePath.push(treePathInfo[i].name);
                        }
                        return [
                            '<div class="tooltip-title">' + echarts.format.encodeHTML(treePath.join('/')) + '</div>',
                            'Time: ' + minutesToTime(value) + ' (' + value + ' min)',
                        ].join('');
                    }
                },
                series: [{
                    type: 'treemap',
                    visibleMin: 300,
                    label: {
                        show: true,
                        formatter: '{b}'
                    },
                    upperLabel: {
                        show: true,
                        height: 30
                    },
                    itemStyle: {
                        borderColor: '#fff'
                    },
                    levels: [
                        {
                            itemStyle: {
                                borderColor: '#777',
                                borderWidth: 0,
                                gapWidth: 1
                            },
                            upperLabel: {
                                show: false
                            }
                        },
                        {
                            itemStyle: {
                                borderColor: '#555',
                                borderWidth: 5,
                                gapWidth: 1
                            },
                            emphasis: {
                                itemStyle: {
                                    borderColor: '#ddd'
                                }
                            }
                        },
                        {
                            colorSaturation: [0.35, 0.5],
                            itemStyle: {
                                borderWidth: 5,
                                gapWidth: 1,
                                borderColorSaturation: 0.6
                            }
                        }
                    ],
                    data: treemapData
                }]
            };
            treemapChart.setOption(treemapOption);
        }

        // --- 11. Streamgraph Chart ---
        var streamgraphData = {"categories": ["\u5a31\u4e50", "\u6742\u9879", "\u6839\u6e90", "\u7b2c\u4e00\u7c7b", "\u7b2c\u4e8c\u7c7b"], "dates": ["2025-06-11", "2025-06-12", "2025-06-13", "2025-06-14", "2025-06-15", "2025-06-16", "2025-06-17", "2025-06-18", "2025-06-19", "2025-06-20", "2025-06-21", "2025-06-22", "2025-06-23", "2025-06-24", "2025-06-25"], "series": [{"data": [272.0, 382.0, 408.0, 287.0, 737.0, 546.0, 605.0, 201.0, 284.0, 416.0, 212.0, 233.0, 270.0, 168.0, 253.0], "name": "\u5a31\u4e50", "type": "line"}, {"data": [276.0, 199.0, 87.0, 72.0, 41.0, 92.0, 193.0, 159.0, 36.0, 193.0, 202.0, 421.0, 377.0, 213.0, 230.0], "name": "\u6742\u9879", "type": "line"}, {"data": [20.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 47.0, 407.0, 163.0, 210.0, 0.0, 83.0, 0.0, 0.0], "name": "\u6839\u6e90", "type": "line"}, {"data": [0.0, 0.0, 0.0, 162.0, 0.0, 107.0, 0.0, 0.0, 0.0, 0.0, 43.0, 80.0, 0.0, 28.0, 0.0], "name": "\u7b2c\u4e00\u7c7b", "type": "line"}, {"data": [267.0, 306.0, 390.0, 256.0, 58.0, 142.0, 69.0, 455.0, 159.0, 119.0, 178.0, 129.0, 80.0, 523.0, 454.0], "name": "\u7b2c\u4e8c\u7c7b", "type": "line"}]};
        var streamgraphChartDom = document.getElementById('streamgraph-chart-container');
        if (streamgraphChartDom && streamgraphData) {
            var streamgraphChart = echarts.init(streamgraphChartDom, 'dark');
            var streamgraphOption = {
                title: {
                    text: 'Streamgraph of Time Allocation Over Time',
                    left: 'center',
                    textStyle: { color: '#eee' }
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'line'
                    }
                },
                legend: {
                    data: streamgraphData.categories,
                    top: 'bottom',
                    textStyle: { color: '#ccc' }
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '10%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    boundaryGap: false,
                    data: streamgraphData.dates,
                    axisLine: { lineStyle: { color: '#888' } },
                    axisLabel: { color: '#ccc' }
                },
                yAxis: {
                    type: 'value',
                     axisLabel: {
                        formatter: function (value) {
                            return minutesToTime(value);
                        },
                        color: '#ccc'
                    }
                },
                series: streamgraphData.series.map(s => Object.assign(s, {
                    type: 'line',
                    stack: 'Total',
                    areaStyle: {},
                    emphasis: {
                        focus: 'series'
                    },
                    smooth: true
                }))
            };
            streamgraphChart.setOption(streamgraphOption);
        }

        // --- 12. Small Multiples ---
        var smallMultiplesData = {"categories": ["\u5a31\u4e50", "\u6742\u9879", "\u6839\u6e90", "\u7b2c\u4e00\u7c7b", "\u7b2c\u4e8c\u7c7b"], "dates": ["2025-06-11", "2025-06-12", "2025-06-13", "2025-06-14", "2025-06-15", "2025-06-16", "2025-06-17", "2025-06-18", "2025-06-19", "2025-06-20", "2025-06-21", "2025-06-22", "2025-06-23", "2025-06-24", "2025-06-25"], "series": [{"data": [272.0, 382.0, 408.0, 287.0, 737.0, 546.0, 605.0, 201.0, 284.0, 416.0, 212.0, 233.0, 270.0, 168.0, 253.0], "name": "\u5a31\u4e50", "type": "line"}, {"data": [276.0, 199.0, 87.0, 72.0, 41.0, 92.0, 193.0, 159.0, 36.0, 193.0, 202.0, 421.0, 377.0, 213.0, 230.0], "name": "\u6742\u9879", "type": "line"}, {"data": [20.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 47.0, 407.0, 163.0, 210.0, 0.0, 83.0, 0.0, 0.0], "name": "\u6839\u6e90", "type": "line"}, {"data": [0.0, 0.0, 0.0, 162.0, 0.0, 107.0, 0.0, 0.0, 0.0, 0.0, 43.0, 80.0, 0.0, 28.0, 0.0], "name": "\u7b2c\u4e00\u7c7b", "type": "line"}, {"data": [267.0, 306.0, 390.0, 256.0, 58.0, 142.0, 69.0, 455.0, 159.0, 119.0, 178.0, 129.0, 80.0, 523.0, 454.0], "name": "\u7b2c\u4e8c\u7c7b", "type": "line"}]};
        var smallMultiplesContainer = document.getElementById('small-multiples-container');
        if (smallMultiplesContainer && smallMultiplesData && smallMultiplesData.categories) {
            smallMultiplesData.categories.forEach((category, index) => {
                // Create a container for each small multiple
                var chartDiv = document.createElement('div');
                chartDiv.className = 'small-multiple-chart';
                chartDiv.style.width = '30%';
                chartDiv.style.height = '300px';
                chartDiv.style.display = 'inline-block';
                chartDiv.style.margin = '1.5%';
                smallMultiplesContainer.appendChild(chartDiv);

                var smallChart = echarts.init(chartDiv, 'dark');
                var seriesData = smallMultiplesData.series.find(s => s.name === category);

                var option = {
                    title: {
                        text: category,
                        left: 'center',
                        textStyle: {
                            color: '#eee',
                            fontSize: 14
                        }
                    },
                    grid: {
                        left: '10%',
                        right: '10%',
                        top: '20%',
                        bottom: '15%',
                        containLabel: true
                    },
                    xAxis: {
                        type: 'category',
                        data: smallMultiplesData.dates,
                        axisLabel: {
                            show: false // Hide labels to keep it clean
                        },
                         axisTick: {
                            show: false
                        }
                    },
                    yAxis: {
                        type: 'value',
                        axisLabel: {
                            formatter: function(value) {
                                if (value >= 60) return (value/60).toFixed(1) + 'h';
                                return value + 'm';
                            },
                            fontSize: 10
                        }
                    },
                    tooltip: {
                        trigger: 'axis'
                    },
                    series: [{
                        name: category,
                        type: 'line',
                        data: seriesData.data,
                        smooth: true,
                        symbolSize: 4
                    }]
                };
                smallChart.setOption(option);
            });
        }

        // Make charts responsive
        window.addEventListener('resize', function() {
            // ... existing resize listeners ...
            if (historicalChart) historicalChart.resize();
            if (treemapChart) treemapChart.resize();
            if (streamgraphChart) streamgraphChart.resize();
            // Small multiples will also need resizing
            var smallCharts = document.querySelectorAll('.small-multiple-chart');
            smallCharts.forEach(chartElement => {
                var chartInstance = echarts.getInstanceByDom(chartElement);
                if(chartInstance) chartInstance.resize();
            });
        });
    </script>
</body>
</html> 