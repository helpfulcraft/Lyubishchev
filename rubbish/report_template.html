<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>柳比歇夫时间统计报告</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f7fa;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1, h2 {
            color: #2c3e50;
            text-align: center;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        .card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
            margin-bottom: 20px;
        }
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .summary-item {
            background-color: #f8f9fa;
            border-left: 5px solid; /* Will be set dynamically */
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .summary-item h3 {
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 1.2em;
            color: #2c3e50;
        }
        .summary-item .total-time {
            font-size: 2em;
            font-weight: bold;
            color: #34495e;
            margin-bottom: 15px;
        }
        .summary-item .subcategory {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            color: #555;
            line-height: 1.5;
        }
        .tab-container {
            margin-bottom: 20px;
        }
        .tab-buttons {
            display: flex;
            border-bottom: 2px solid #ddd;
            flex-wrap: wrap;
        }
        .tab-button {
            padding: 10px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            color: #666;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
        }
        .tab-button.active {
            color: #3498db;
            border-bottom-color: #3498db;
        }
        .tab-content {
            display: none;
            padding: 20px 0;
        }
        .tab-content.active {
            display: block;
        }
        .chart-container {
            height: 500px;
            width: 100%;
        }
        .footer {
            margin-top: 30px;
            text-align: center;
            font-size: 0.9em;
            color: #888;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>柳比歇夫时间统计报告</h1>

        <div class="card">
            <h2>日总览</h2>
            <div class="summary-grid">
                <!-- Jinja2 loop for summary cards -->
                {% for category in chart_data %}
                <div class="summary-item" style="border-left-color: {{ category.itemStyle.color }};">
                    <h3>{{ category.name }}</h3>
                    <div class="total-time">{{ category.value_str }}</div>
                    {% for subcategory in category.children %}
                    <div class="subcategory">
                        <span>{{ subcategory.name }}</span>
                        <strong>{{ subcategory.value_str }}</strong>
                    </div>
                    {% endfor %}
                </div>
                {% endfor %}

                <!-- Grand Total Card -->
                <div class="summary-item" style="border-left-color: #7f8c8d;">
                    <h3>总计</h3>
                    <div class="total-time">{{ data.daily_summary['总计'] }}</div>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>每日详情</h2>
            <div class="summary-grid">
                {% for category, items in data.daily_details.items() %}
                <div class="summary-item" style="border-left-color: {{ chart_data | selectattr('name', 'equalto', category) | map(attribute='itemStyle.color') | first | default('#7f8c8d') }};">
                    <h3>{{ category }}</h3>
                    {% for item, tasks in items.items() %}
                        <div class="subcategory">
                            <span>{{ item }}</span>
                            <strong>{{ tasks | join(', ') }}</strong>
                        </div>
                    {% endfor %}
                </div>
                {% endfor %}
            </div>
        </div>

        <div class="card">
            <h2>时间分配比例</h2>
            <div class="tab-container">
                <div class="tab-buttons">
                    <button class="tab-button active" onclick="openTab(event, 'sunburstChart')">旭日图</button>
                    <button class="tab-button" onclick="openTab(event, 'pieChart')">饼图</button>
                </div>
                <div id="sunburstChart" class="tab-content active">
                    <div class="chart-container" id="sunburstChartContainer"></div>
                </div>
                <div id="pieChart" class="tab-content">
                    <div class="chart-container" id="pieChartContainer"></div>
                </div>
            </div>
        </div>
        
        <div class="footer">
            <p>报告生成于 {{ generation_time }}</p>
        </div>
    </div>

    <script>
        // --- Utility Functions (from example) ---
        function minutesToTime(minutes) {
            if (minutes === null || minutes === undefined || minutes < 0) return '0m';
            if (minutes === 0) return '0m';
            const hours = Math.floor(minutes / 60);
            const mins = minutes % 60;
            let result = '';
            if (hours > 0) result += `${hours}h`;
            if (mins > 0) result += (hours > 0 ? ' ' : '') + `${mins}m`;
            return result;
        }
        
        // --- Data from Python ---
        const chartData = {{ chart_data | tojson }};
        const pieData = {{ pie_data | tojson }};

        // --- Chart Initialization ---
        function initCharts() {
            // --- Sunburst Chart ---
            const sunburstChart = echarts.init(document.getElementById('sunburstChartContainer'));
            sunburstChart.setOption({
                title: { text: '时间分配层次结构', left: 'center' },
                tooltip: {
                    trigger: 'item',
                    formatter: function(params) {
                        return `${params.name}: ${minutesToTime(params.value)}`;
                    }
                },
                series: {
                    type: 'sunburst',
                    data: chartData,
                    radius: [0, '90%'],
                    label: {
                        rotate: 'radial',
                        formatter: function(params) {
                            return params.value > 60 ? `${params.name}\\n${minutesToTime(params.value)}` : params.name;
                        }
                    },
                    levels: [{}, { r0: '15%', r: '45%' }, { r0: '45%', r: '85%' }],
                    emphasis: { focus: 'ancestor' }
                }
            });

            // --- Pie Chart ---
            const pieChart = echarts.init(document.getElementById('pieChartContainer'));
            pieChart.setOption({
                title: { text: '时间分配比例 (主类)', left: 'center' },
                tooltip: {
                    trigger: 'item',
                    formatter: function(params) {
                        return `${params.seriesName}<br/>${params.name}: ${minutesToTime(params.value)} (${params.percent}%)`;
                    }
                },
                legend: { orient: 'vertical', left: 'left' },
                series: [{
                    name: '时间分配',
                    type: 'pie',
                    radius: '65%',
                    center: ['50%', '55%'],
                    data: pieData,
                    emphasis: {
                        itemStyle: { shadowBlur: 10, shadowOffsetX: 0, shadowColor: 'rgba(0, 0, 0, 0.5)' }
                    },
                }]
            });

            // Resize charts on window resize
            window.addEventListener('resize', function() {
                sunburstChart.resize();
                pieChart.resize();
            });
        }

        // --- Tab Switching Logic ---
        function openTab(evt, tabName) {
            const currentContainer = evt.currentTarget.closest('.tab-container');
            const tabContents = currentContainer.querySelectorAll('.tab-content');
            tabContents.forEach(tab => tab.classList.remove('active'));
            
            const tabButtons = currentContainer.querySelectorAll('.tab-button');
            tabButtons.forEach(btn => btn.classList.remove('active'));
            
            document.getElementById(tabName).classList.add('active');
            evt.currentTarget.classList.add('active');

            // Force resize chart in the new active tab
            setTimeout(() => {
                const chartElement = document.getElementById(tabName)?.querySelector('.chart-container');
                if (chartElement && chartElement.id) {
                    const chartInstance = echarts.getInstanceByDom(chartElement);
                    if (chartInstance) chartInstance.resize();
                }
            }, 50);
        }

        // --- Page Load ---
        window.onload = function() {
            initCharts();
            // Ensure initial active chart is sized correctly
            setTimeout(() => {
                const activeChartElement = document.querySelector('.tab-content.active .chart-container');
                if (activeChartElement) {
                    const chartInstance = echarts.getInstanceByDom(activeChartElement);
                    if (chartInstance) chartInstance.resize();
                }
            }, 100);
        };
    </script>
</body>
</html> 